name: LLM Trading Agent Evolution

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * 0'  # Weekly (Sunday midnight)
  push:
    branches: [ main ]
    paths:
      - 'llm-evolution/'

jobs:
  evolve:
    runs-on: ubuntu-latest
    
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      EVOLUTION_INTERVAL: ${{ secrets.EVOLUTION_INTERVAL || '7' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests numpy
    
    - name: Run evolution cycle
      run: |
        echo "=== LLM Trading Agent Evolution ==="
        echo "Date: $(date)"
        echo ""
        
        # Run evolution
        python llm-evolution/evolution_engine.py --evolve
        
        echo ""
        echo "=== Evolution Complete ==="
        cat llm-evolution/population.json | python3 -m json.tool
    
    - name: Upload evolution results
      uses: actions/upload-artifact@v4
      with:
        name: evolution-results
        path: |
          llm-evolution/population.json
          llm-evolution/generations/
        retention-days: 30
    
    - name: Create summary
      run: |
        echo "## Weekly Evolution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Generated: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- Agents evolved: $(cat llm-evolution/population.json | python3 -c 'import sys,json; print(len(json.load(sys.stdin)[\"population\"]))')" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "llm-evolution/generations/gen_latest.json" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Top Performers" >> $GITHUB_STEP_SUMMARY
          cat llm-evolution/generations/gen_latest.json | python3 -c '
import sys,json
data=json.load(sys.stdin)
agents=sorted(data["agents"], key=lambda x: x.get("fitness",0), reverse=True)[:3]
for a in agents:
  print(f"- {a[\"name\"]}: fitness={a.get(\"fitness\",0):.2f}, Sharpe={a.get(\"sharpe\",0):.2f}")
' >> $GITHUB_STEP_SUMMARY
        fi

  analyze:
    runs-on: ubuntu-latest
    needs: evolve
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Analyze market and select profile
      run: |
        echo "=== Market Analysis ==="
        python llm-evolution/analyze_market.py
        
        echo ""
        echo "=== Profile Recommendation ==="
        python llm-evolution/recommend_profile.py

  notify:
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - name: Create notification
      run: |
        echo "## LLM Evolution Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [View Evolution Results](${{ github.server_url }}/${{ github.repository }}/actions/workflows/llm-evolution.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- [View Population](${{ github.server_url }}/${{ github.repository }}/blob/main/llm-evolution/population.json)" >> $GITHUB_STEP_SUMMARY
